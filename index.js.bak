require("dotenv").config();
const TelegramBot = require("node-telegram-bot-api");
const Imap = require("imap");
const { simpleParser } = require("mailparser");

let userEmail = "";
let userPassword = "";

const bot = new TelegramBot(process.env.BOT_TOKEN, { polling: true });

bot.onText(/\/start/, (msg) => {
  const chatId = msg.chat.id;
  bot.sendMessage(chatId, "Choose what you want to fetch:", {
    reply_markup: {
      keyboard: [
        [{ text: "ğŸ” Sign-in Code" }],
        [{ text: "ğŸ  Household Access" }],
      ],
      resize_keyboard: true,
    },
  });
});

bot.onText(/\/setgmail (.+) (.+)/, (msg, match) => {
  const chatId = msg.chat.id;
  userEmail = match[1];
  userPassword = match[2];

  console.log(`ğŸ“§ Gmail set: ${userEmail}`);
  bot.sendMessage(chatId, `âœ… Gmail set for *${userEmail}*. Now press /start`, {
    parse_mode: "Markdown",
  });
});

bot.on("message", async (msg) => {
  const chatId = msg.chat.id;
  const text = msg.text;

  if (text === "ğŸ” Sign-in Code" || text === "ğŸ  Household Access") {
    bot.sendMessage(chatId, "â³ Checking Gmail...");
    console.log("ğŸ“¨ Fetch requested:", text);

    const imap = new Imap({
      user: userEmail,
      password: userPassword,
      host: "imap.gmail.com",
      port: 993,
      tls: true,
      tlsOptions: { rejectUnauthorized: false },
    });

    imap.once("ready", function () {
      console.log("âœ… IMAP connected.");
      imap.openBox("INBOX", false, function (err, box) {
        if (err) {
          console.log("ğŸ“¦ Inbox error:", err);
          bot.sendMessage(chatId, "âŒ Error opening inbox.");
          imap.end();
          return;
        }

        const searchCriteria = [["FROM", "Netflix"], ["SINCE", new Date(Date.now() - 24 * 60 * 60 * 1000)]];
        const fetchOptions = { bodies: ["HEADER", "TEXT"], struct: true };

        imap.search(searchCriteria, function (err, results) {
          if (err || results.length === 0) {
            console.log("ğŸ“­ No matching emails.");
            bot.sendMessage(chatId, "âŒ No matching Netflix mail found.");
            imap.end();
            return;
          }

          const latest = results[results.length - 1];
          console.log("ğŸ“¥ Fetching latest email:", latest);
          const f = imap.fetch(latest, fetchOptions);

          f.on("message", function (msg, seqno) {
            let responded = false;

            msg.on("body", function (stream, info) {
              simpleParser(stream, async (err, parsed) => {
                if (err) {
                  console.log("âŒ Parse error:", err);
                  if (!responded) {
                    bot.sendMessage(chatId, "âŒ Error parsing email.");
                    responded = true;
                  }
                  imap.end();
                  return;
                }

                const body = parsed.text || "";
                console.log("ğŸ“¨ Email body received.");

                if (text === "ğŸ” Sign-in Code" && !responded && body.includes("sign in to Netflix")) {
                  const codeMatch = body.match(/\b\d{4}\b/);
                  if (codeMatch) {
                    responded = true;
                    console.log("ğŸ” Code found:", codeMatch[0]);
                    bot.sendMessage(chatId, `ğŸ” Your Netflix Sign-in Code is: *${codeMatch[0]}*`, {
                      parse_mode: "Markdown",
                    });
                  }
                } else if (text === "ğŸ  Household Access" && !responded && body.includes("accountaccess")) {
                  const linkMatch = body.match(/https:\/\/www\.netflix\.com\/accountaccess[^\s]+/);
                  if (linkMatch) {
                    responded = true;
                    console.log("ğŸ  Link found:", linkMatch[0]);
                    bot.sendMessage(chatId, `ğŸ  Your Netflix Household Link:\n${linkMatch[0]}`);
                  }
                }

                if (!responded) {
                  console.log("âŒ Email didn't contain expected info.");
                  bot.sendMessage(chatId, "âŒ No useful Netflix info found.");
                  responded = true;
                }

                imap.end();
              });
            });
          });

          f.once("error", function (err) {
            console.log("âŒ Fetch error:", err);
            bot.sendMessage(chatId, `âŒ Fetch error: ${err.message}`);
            imap.end();
          });

          f.once("end", function () {
            console.log("ğŸ“¥ Email fetch complete.");
            imap.end();
          });
        });
      });
    });

    imap.once("error", function (err) {
      console.log("âŒ IMAP error:", err);
      bot.sendMessage(chatId, `âŒ IMAP error: ${err.message}`);
      imap.end();
    });

    imap.once("end", function () {
      console.log("ğŸ“´ IMAP connection closed.");
    });

    imap.connect();
  }
});
